{% extends "instructor_layout.html" %}

{% block title %}Enroll Students{% endblock %}

{% block content %}
<div class="content-header">
    <h2>Enrolled Students</h2>
    <div class="student-count">
        <span id="studentCounter">0</span>
        <div class="student-icon">
            <i class="fas fa-user"></i>
        </div>
    </div>
</div>
<div class="search-add-section">
    <div class="search-box">
        <input type="text" class="form-control" id="searchInput" placeholder="Search">
        <button class="search-btn" id="searchBtn">
            <i class="fas fa-search"></i>
        </button>
    </div>
    <button class="btn-add-student" id="btnEnrollStudent">
        <i class="fas fa-plus"></i> Enroll Student
    </button>
</div>
<div class="table-responsive">
    <table class="table">
        <thead>
            <tr>
                <th>Name</th>
                <th>ID Number</th>
                <th>Year Level <i class="fas fa-sort sort-icon" id="sortYearLevel"></i></th>
                <th>Phone Number</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="studentsTableBody">
            <!-- Student rows will be added dynamically -->
            <tr>
                <td colspan="5" class="text-center">Loading students...</td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Enroll Student Modal -->
<div class="modal-overlay" id="enrollModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Enroll Student</h3>
                <button class="close-btn" id="closeEnrollModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="enrollStudentForm">
                    <div class="form-group">
                        <input type="text" class="form-control" id="firstName" name="firstName" placeholder="First Name" required>
                    </div>
                    <div class="form-group">
                        <input type="text" class="form-control" id="lastName" name="lastName" placeholder="Last Name" required>
                    </div>
                    <div class="form-group">
                        <input type="tel" class="form-control" id="phoneNumber" name="phone" placeholder="Phone Number (09XXXXXXXXX)" required>
                        <div class="invalid-feedback">Phone number must start with 09 and have 11 digits total</div>
                    </div>
                    <div class="form-group">
                        <select class="form-control" id="yearLevel" name="yearLevel" required>
                            <option value="">Select Year Level</option>
                            <option value="1st Year">1st Year</option>
                            <option value="2nd Year">2nd Year</option>
                            <option value="3rd Year">3rd Year</option>
                            <option value="4th Year">4th Year</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <input type="text" class="form-control" id="idNumber" name="id" placeholder="ID Number" readonly>
                        <small class="text-muted">ID will be generated automatically</small>
                    </div>
                    <div class="form-group">
                        <input type="email" class="form-control" id="email" name="email" placeholder="Email (Optional)">
                    </div>
                    <button type="submit" class="btn-proceed">Proceed</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Student Pictures Modal -->
<div class="modal-overlay" id="picturesModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Student Facial Recognition Images</h3>
                <button class="close-btn" id="closePicturesModal">&times;</button>
            </div>
            <div class="modal-body">
                <h4 class="pictures-title mb-3" id="student-name-display"></h4>
                <p class="mb-3 text-muted">Upload clear frontal face images for facial recognition attendance. Multiple angles improve recognition accuracy.</p>
                
                <div class="pictures-preview" id="current-pictures-container">
                    <div class="picture-container picture-placeholder">
                        <i class="fas fa-camera fa-2x mb-2"></i>
                        <span>No images yet</span>
                    </div>
                </div>
                
                <form id="student-image-form" enctype="multipart/form-data">
                    <input type="hidden" id="student-id-for-image">
                    <div class="image-upload-container">
                        <div class="form-group mb-3">
                            <label for="student-image-upload" class="form-label">
                                <i class="fas fa-cloud-upload-alt me-2"></i>Upload New Face Image
                            </label>
                            <input type="file" class="form-control" id="student-image-upload" name="image" accept="image/jpeg,image/png" required>
                            <div class="form-text mt-2">
                                <small><i class="fas fa-info-circle me-1"></i>Supported formats: JPG, JPEG, PNG</small><br>
                                <small><i class="fas fa-info-circle me-1"></i>Clear, well-lit frontal face photos work best</small><br>
                                <small><i class="fas fa-info-circle me-1"></i>Max file size: 5MB</small>
                            </div>
                        </div>
                        <button type="submit" class="btn-save">
                            <i class="fas fa-upload me-2"></i>Upload Image
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Student Modal -->
<div class="modal-overlay" id="editModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Student</h3>
                <button class="close-btn" id="closeEditModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editStudentForm">
                    <input type="hidden" id="editStudentId">
                    <div class="form-group">
                        <input type="text" class="form-control" id="editFirstName" placeholder="First Name" required>
                    </div>
                    <div class="form-group">
                        <input type="text" class="form-control" id="editLastName" placeholder="Last Name" required>
                    </div>
                    <div class="form-group">
                        <input type="tel" class="form-control" id="editPhoneNumber" placeholder="Phone Number" required>
                    </div>
                    <div class="form-group">
                        <select class="form-control" id="editYearLevel" required>
                            <option value="">Select Year Level</option>
                            <option value="1st Year">1st Year</option>
                            <option value="2nd Year">2nd Year</option>
                            <option value="3rd Year">3rd Year</option>
                            <option value="4th Year">4th Year</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <input type="text" class="form-control" id="editIdNumber" placeholder="ID Number" readonly>
                    </div>
                    <div class="form-group">
                        <input type="email" class="form-control" id="editEmail" placeholder="Email (Optional)">
                    </div>
                    <button type="submit" class="btn-proceed">Update</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal-overlay confirm-modal" id="confirmationModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body text-center">
                <h4>Are You Sure?</h4>
                <p>Do you want to delete this student?</p>
                <div class="confirmation-buttons">
                    <button id="confirmYesBtn" class="btn-yes">Yes</button>
                    <button id="confirmNoBtn" class="btn-no">No</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // DOM element references
    const elements = {
        // Student counter
        studentCounter: document.getElementById('studentCounter'),
        // Tables
        studentsTableBody: document.getElementById('studentsTableBody'),
        // Search
        searchInput: document.getElementById('searchInput'),
        searchBtn: document.getElementById('searchBtn'),
        sortYearLevel: document.getElementById('sortYearLevel'),
        // Buttons
        btnEnrollStudent: document.getElementById('btnEnrollStudent'),
        // Modals
        enrollModal: document.getElementById('enrollModal'),
        picturesModal: document.getElementById('picturesModal'),
        editModal: document.getElementById('editModal'),
        confirmationModal: document.getElementById('confirmationModal'),
        // Modal close buttons
        closeEnrollModal: document.getElementById('closeEnrollModal'),
        closePicturesModal: document.getElementById('closePicturesModal'),
        closeEditModal: document.getElementById('closeEditModal'),
        // Modal confirmation buttons
        confirmYesBtn: document.getElementById('confirmYesBtn'),
        confirmNoBtn: document.getElementById('confirmNoBtn'),
        // Forms
        enrollStudentForm: document.getElementById('enrollStudentForm'),
        editStudentForm: document.getElementById('editStudentForm'),
        studentImageForm: document.getElementById('student-image-form')
    };

    // Application state
    const state = {
        students: [],
        currentStudentId: null,
        sortOrderAsc: true
    };
    
    // Initialize
    init();
    
    // Main initialization function
    function init() {
        loadStudents();
        setupEventListeners();
        generateStudentId();
    }
    
    // Setup all event listeners
    function setupEventListeners() {
        // Modal open/close
        elements.btnEnrollStudent.addEventListener('click', () => showModal(elements.enrollModal));
        elements.closeEnrollModal.addEventListener('click', () => hideModal(elements.enrollModal));
        elements.closePicturesModal.addEventListener('click', () => hideModal(elements.picturesModal));
        elements.closeEditModal.addEventListener('click', () => hideModal(elements.editModal));
        
        // Search and sort
        elements.searchInput.addEventListener('input', handleSearch);
        elements.searchBtn.addEventListener('click', handleSearch);
        elements.sortYearLevel.addEventListener('click', handleSortByYearLevel);
        
        // Form submissions
        elements.enrollStudentForm.addEventListener('submit', handleEnrollSubmit);
        elements.editStudentForm.addEventListener('submit', handleEditSubmit);
        elements.studentImageForm.addEventListener('submit', handleImageUpload);
        
        // Confirmation dialog
        elements.confirmYesBtn.addEventListener('click', handleDelete);
        elements.confirmNoBtn.addEventListener('click', () => hideModal(elements.confirmationModal));
    }
    
    // Load students from the server
    async function loadStudents() {
        try {
            // Get all students related to the instructor's classes
            const response = await fetch('/instructors/api/my-students');
            const students = await response.json();
            
            state.students = students;
            elements.studentCounter.textContent = students.length;
            
            renderStudentsTable(students);
        } catch (error) {
            console.error('Error loading students:', error);
            elements.studentsTableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-danger">
                        Error loading students. Please try again later.
                    </td>
                </tr>
            `;
        }
    }
    
    // Generate a new student ID
    async function generateStudentId() {
        try {
            const response = await fetch('/instructors/api/generate-student-id');
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('idNumber').value = data.id;
            }
        } catch (error) {
            console.error('Error generating student ID:', error);
        }
    }
    
    // Render the students table
    function renderStudentsTable(students) {
        elements.studentsTableBody.innerHTML = '';
        
        if (students.length === 0) {
            elements.studentsTableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center">No students found</td>
                </tr>
            `;
            return;
        }
        
        students.forEach(student => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${student.firstName} ${student.lastName}</td>
                <td>${student.id}</td>
                <td>${student.yearLevel}</td>
                <td>${student.phone}</td>
                <td>
                    <button class="action-btn btn-edit" data-student-id="${student.id}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn btn-pictures" data-student-id="${student.id}" 
                        data-student-name="${student.firstName} ${student.lastName}">
                        <i class="fas fa-camera"></i>
                    </button>
                    <button class="action-btn btn-delete" data-student-id="${student.id}">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </td>
            `;
            
            // Add event listeners to the buttons
            const editBtn = row.querySelector('.btn-edit');
            const picturesBtn = row.querySelector('.btn-pictures');
            const deleteBtn = row.querySelector('.btn-delete');
            
            editBtn.addEventListener('click', () => showEditModal(student));
            picturesBtn.addEventListener('click', () => showPicturesModal(student.id, `${student.firstName} ${student.lastName}`));
            deleteBtn.addEventListener('click', () => showDeleteConfirmation(student.id));
            
            elements.studentsTableBody.appendChild(row);
        });
    }
    
    // Show a modal
    function showModal(modal) {
        modal.classList.add('show');
    }
    
    // Hide a modal
    function hideModal(modal) {
        modal.classList.remove('show');
    }
    
    // Show the edit student modal
    function showEditModal(student) {
        state.currentStudentId = student.id;
        
        document.getElementById('editStudentId').value = student.id;
        document.getElementById('editFirstName').value = student.firstName;
        document.getElementById('editLastName').value = student.lastName;
        document.getElementById('editPhoneNumber').value = student.phone;
        document.getElementById('editYearLevel').value = student.yearLevel;
        document.getElementById('editIdNumber').value = student.id;
        document.getElementById('editEmail').value = student.email || '';
        
        showModal(elements.editModal);
    }
    
    // Show the student pictures modal
    async function showPicturesModal(studentId, studentName) {
        state.currentStudentId = studentId;
        
        document.getElementById('student-id-for-image').value = studentId;
        document.getElementById('student-name-display').textContent = studentName;
        
        // Reset the image upload form
        elements.studentImageForm.reset();
        
        // Load student images
        try {
            const response = await fetch(`/instructors/api/student-images/${studentId}`);
            const data = await response.json();
            
            if (data.success) {
                const container = document.getElementById('current-pictures-container');
                container.innerHTML = '';
                
                if (data.images.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted">No images available</div>';
                } else {
                    data.images.forEach(image => {
                        const imgContainer = document.createElement('div');
                        imgContainer.className = 'position-relative';
                        imgContainer.innerHTML = `
                            <img src="${image.path}" alt="Student" class="student-image img-thumbnail mb-2">
                            <button type="button" class="btn btn-sm btn-danger delete-image-btn" data-image-id="${image.id}">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        
                        const deleteBtn = imgContainer.querySelector('.delete-image-btn');
                        deleteBtn.addEventListener('click', () => deleteStudentImage(image.id));
                        
                        container.appendChild(imgContainer);
                    });
                }
            } else {
                console.error('Error loading student images:', data.message);
            }
        } catch (error) {
            console.error('Error loading student images:', error);
        }
        
        showModal(elements.picturesModal);
    }
    
    // Show delete confirmation modal
    function showDeleteConfirmation(studentId) {
        state.currentStudentId = studentId;
        showModal(elements.confirmationModal);
    }
    
    // Handle search input
    function handleSearch() {
        const searchTerm = elements.searchInput.value.toLowerCase();
        
        if (!searchTerm) {
            renderStudentsTable(state.students);
            return;
        }
        
        const filteredStudents = state.students.filter(student => 
            student.firstName.toLowerCase().includes(searchTerm) || 
            student.lastName.toLowerCase().includes(searchTerm) ||
            student.id.toLowerCase().includes(searchTerm) ||
            student.yearLevel.toLowerCase().includes(searchTerm) ||
            student.phone.includes(searchTerm)
        );
        
        renderStudentsTable(filteredStudents);
    }
    
    // Handle sort by year level
    function handleSortByYearLevel() {
        state.sortOrderAsc = !state.sortOrderAsc;
        
        const yearLevelOrder = {
            '1st Year': 1,
            '2nd Year': 2,
            '3rd Year': 3,
            '4th Year': 4
        };
        
        const sortedStudents = [...state.students].sort((a, b) => {
            const orderA = yearLevelOrder[a.yearLevel] || 0;
            const orderB = yearLevelOrder[b.yearLevel] || 0;
            
            return state.sortOrderAsc ? orderA - orderB : orderB - orderA;
        });
        
        renderStudentsTable(sortedStudents);
        
        // Update sort icon
        elements.sortYearLevel.className = state.sortOrderAsc 
            ? 'fas fa-sort-up sort-icon' 
            : 'fas fa-sort-down sort-icon';
    }
    
    // Handle enroll student form submission
    async function handleEnrollSubmit(e) {
        e.preventDefault();
        
        // Validate phone number
        const phoneInput = document.getElementById('phoneNumber');
        const phoneRegex = /^09\d{9}$/;
        if (!phoneRegex.test(phoneInput.value)) {
            phoneInput.classList.add('is-invalid');
            return;
        } else {
            phoneInput.classList.remove('is-invalid');
        }
        
        // Create student data object
        const studentData = {
            firstName: document.getElementById('firstName').value,
            lastName: document.getElementById('lastName').value,
            phone: phoneInput.value,
            yearLevel: document.getElementById('yearLevel').value,
            id: document.getElementById('idNumber').value,
            email: document.getElementById('email').value || null
        };
        
        try {
            const response = await fetch('/instructors/api/create-student', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(studentData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('Student enrolled successfully!');
                elements.enrollStudentForm.reset();
                hideModal(elements.enrollModal);
                
                // Refresh the student list
                loadStudents();
                
                // Generate a new ID for the next student
                generateStudentId();
            } else {
                alert(`Error: ${result.message}`);
            }
        } catch (error) {
            console.error('Error enrolling student:', error);
            alert('Error enrolling student. Please try again.');
        }
    }
    
    // Handle edit student form submission
    async function handleEditSubmit(e) {
        e.preventDefault();
        
        // Validate phone number
        const phoneInput = document.getElementById('editPhoneNumber');
        const phoneRegex = /^09\d{9}$/;
        if (!phoneRegex.test(phoneInput.value)) {
            phoneInput.classList.add('is-invalid');
            return;
        } else {
            phoneInput.classList.remove('is-invalid');
        }
        
        // Create student data object
        const studentData = {
            firstName: document.getElementById('editFirstName').value,
            lastName: document.getElementById('editLastName').value,
            phone: phoneInput.value,
            yearLevel: document.getElementById('editYearLevel').value,
            email: document.getElementById('editEmail').value || null
        };
        
        try {
            const response = await fetch(`/instructors/api/update-student/${state.currentStudentId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(studentData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('Student updated successfully!');
                hideModal(elements.editModal);
                
                // Refresh the student list
                loadStudents();
            } else {
                alert(`Error: ${result.message}`);
            }
        } catch (error) {
            console.error('Error updating student:', error);
            alert('Error updating student. Please try again.');
        }
    }
    
    // Handle student image upload
    async function handleImageUpload(e) {
        e.preventDefault();
        
        const studentId = document.getElementById('student-id-for-image').value;
        const imageFile = document.getElementById('student-image-upload').files[0];
        
        if (!studentId || !imageFile) {
            alert('Please select an image to upload');
            return;
        }
        
        const formData = new FormData();
        formData.append('image', imageFile);
        
        try {
            const response = await fetch(`/instructors/api/upload-student-image/${studentId}`, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert(result.message);
                
                // Reload the pictures modal to show the new image
                const student = state.students.find(s => s.id === studentId);
                if (student) {
                    showPicturesModal(studentId, `${student.firstName} ${student.lastName}`);
                }
            } else {
                alert(`Error uploading image: ${result.message}`);
            }
        } catch (error) {
            console.error('Error uploading image:', error);
            alert('Error uploading image. Please try again.');
        }
    }
    
    // Delete student image
    async function deleteStudentImage(imageId) {
        if (!confirm('Are you sure you want to delete this image?')) {
            return;
        }
        
        try {
            const response = await fetch(`/instructors/api/delete-student-image/${imageId}`, {
                method: 'POST'
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Reload the pictures modal
                const studentId = document.getElementById('student-id-for-image').value;
                const student = state.students.find(s => s.id === studentId);
                if (student) {
                    showPicturesModal(studentId, `${student.firstName} ${student.lastName}`);
                }
            } else {
                alert(`Error deleting image: ${result.message}`);
            }
        } catch (error) {
            console.error('Error deleting image:', error);
            alert('Error deleting image. Please try again.');
        }
    }
    
    // Handle student deletion
    async function handleDelete() {
        try {
            const response = await fetch(`/instructors/api/delete-student/${state.currentStudentId}`, {
                method: 'POST'
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('Student deleted successfully!');
                hideModal(elements.confirmationModal);
                
                // Refresh the student list
                loadStudents();
            } else {
                alert(`Error: ${result.message}`);
            }
        } catch (error) {
            console.error('Error deleting student:', error);
            alert('Error deleting student. Please try again.');
        }
    }
});
</script>
{% endblock %}