{% extends "base.html" %}

{% block title %}Instructor Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="mt-4 mb-4">Instructor Dashboard: {{ current_user.first_name }} {{ current_user.last_name }}</h2>
            
            <div class="row">
                <!-- My Classes Card -->
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">My Classes</h5>
                            <div class="d-flex align-items-center mt-3">
                                <div class="display-4 me-3">
                                    <i class="fas fa-chalkboard-teacher text-success"></i>
                                </div>
                                <div class="fs-2 fw-bold" id="class-count">
                                    Loading...
                                </div>
                            </div>
                            <p class="text-muted mt-2">Classes you're teaching</p>
                            <div class="mt-3">
                                <a href="#my-classes-section" class="btn btn-outline-success">View Classes</a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Students Card -->
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">My Students</h5>
                            <div class="d-flex align-items-center mt-3">
                                <div class="display-4 me-3">
                                    <i class="fas fa-user-graduate text-primary"></i>
                                </div>
                                <div class="fs-2 fw-bold" id="student-count">
                                    Loading...
                                </div>
                            </div>
                            <p class="text-muted mt-2">Students in your classes</p>
                            <div class="mt-3">
                                <a href="#my-students-section" class="btn btn-outline-primary">View Students</a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Attendance Card -->
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">Today's Attendance</h5>
                            <div class="d-flex align-items-center mt-3">
                                <div class="display-4 me-3">
                                    <i class="fas fa-clipboard-check text-danger"></i>
                                </div>
                                <div class="fs-2 fw-bold" id="attendance-today">
                                    <span id="present-count">-</span>/<span id="total-count">-</span>
                                </div>
                            </div>
                            <p class="text-muted mt-2">Present today</p>
                            <div class="mt-3">
                                <a href="{{ url_for('attendance.manage') }}" class="btn btn-outline-danger">Take Attendance</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- My Classes Section -->
            <div class="row mt-5" id="my-classes-section">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">My Classes</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Class Code</th>
                                            <th>Course Description</th>
                                            <th>Room</th>
                                            <th>Schedule</th>
                                            <th>Students</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="instructor-classes">
                                        <tr>
                                            <td colspan="6" class="text-center">Loading your classes...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- My Students Section -->
            <div class="row mt-5" id="my-students-section">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">My Students</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>ID</th>
                                            <th>Year Level</th>
                                            <th>Phone</th>
                                            <th>Email</th>
                                            <th>Class</th>
                                            <th>Profile Image</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="instructor-students">
                                        <tr>
                                            <td colspan="8" class="text-center">Loading your students...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Student Image Upload Modal -->
<div class="modal-overlay" id="student-image-modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="student-image-modal-title">Manage Student Images</h5>
                <button type="button" class="close-btn" id="close-student-image-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="student-image-form" enctype="multipart/form-data">
                    <input type="hidden" id="student-id-for-image">
                    <div class="student-info mb-3">
                        <h6 id="student-name-for-image"></h6>
                        <p id="student-id-display"></p>
                    </div>
                    <div class="current-images mb-4">
                        <h6>Current Images</h6>
                        <div id="current-images-container" class="d-flex flex-wrap gap-2">
                            <div class="text-center text-muted">No images available</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="student-image-upload">Upload New Image</label>
                        <input type="file" class="form-control" id="student-image-upload" name="image" accept="image/jpeg,image/png" required>
                        <small class="form-text text-muted">Supported formats: JPG, PNG. Max size: 5MB</small>
                    </div>
                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary">Upload Image</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // Setup event listeners for the modals
        const closeStudentImageModalBtn = document.getElementById('close-student-image-modal');
        if (closeStudentImageModalBtn) {
            closeStudentImageModalBtn.addEventListener('click', () => {
                document.getElementById('student-image-modal').classList.remove('show');
            });
        }
        
        // Setup image upload form submission
        const studentImageForm = document.getElementById('student-image-form');
        if (studentImageForm) {
            studentImageForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const studentId = document.getElementById('student-id-for-image').value;
                const imageFile = document.getElementById('student-image-upload').files[0];
                
                if (!studentId || !imageFile) {
                    alert('Please select an image to upload');
                    return;
                }
                
                const formData = new FormData();
                formData.append('student_id', studentId);
                formData.append('image', imageFile);
                
                try {
                    const response = await fetch('/students/api/upload-image', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('Image uploaded successfully');
                        document.getElementById('student-image-modal').classList.remove('show');
                        // Reload the student data to show the updated images
                        fetchMyStudents();
                    } else {
                        alert(`Error uploading image: ${result.message}`);
                    }
                } catch (error) {
                    console.error('Error uploading image:', error);
                    alert('Error uploading image. Please try again.');
                }
            });
        }
        
        // Fetch instructor data
        fetchInstructorData();
    });
    
    async function fetchInstructorData() {
        try {
            // Fetch instructor classes
            await fetchMyClasses();
            
            // Fetch instructor students
            await fetchMyStudents();
            
            // Fetch attendance data
            await fetchAttendanceData();
        } catch (error) {
            console.error('Error fetching instructor data:', error);
        }
    }
    
    async function fetchMyClasses() {
        try {
            const response = await fetch('/instructors/api/my-classes');
            const classes = await response.json();
            
            // Update class count
            document.getElementById('class-count').textContent = classes.length;
            
            // Render class table
            const classesTableBody = document.getElementById('instructor-classes');
            classesTableBody.innerHTML = '';
            
            if (classes.length === 0) {
                classesTableBody.innerHTML = '<tr><td colspan="6" class="text-center">You have no assigned classes</td></tr>';
                return;
            }
            
            classes.forEach(cls => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${cls.classCode}</td>
                    <td>${cls.description}</td>
                    <td>${cls.roomNumber}</td>
                    <td>${cls.schedule}</td>
                    <td>${cls.enrolledCount}</td>
                    <td>
                        <a href="/classes/view/${cls.id}" class="btn btn-sm btn-outline-primary">View Details</a>
                        <a href="/attendance/manage?class_id=${cls.id}" class="btn btn-sm btn-outline-danger">Take Attendance</a>
                    </td>
                `;
                classesTableBody.appendChild(row);
            });
        } catch (error) {
            console.error('Error fetching classes:', error);
            document.getElementById('instructor-classes').innerHTML = 
                '<tr><td colspan="6" class="text-center text-danger">Error loading classes. Please try again later.</td></tr>';
        }
    }
    
    async function fetchMyStudents() {
        try {
            const response = await fetch('/instructors/api/my-students');
            const students = await response.json();
            
            // Update student count
            document.getElementById('student-count').textContent = students.length;
            
            // Render student table
            const studentsTableBody = document.getElementById('instructor-students');
            studentsTableBody.innerHTML = '';
            
            if (students.length === 0) {
                studentsTableBody.innerHTML = '<tr><td colspan="8" class="text-center">You have no enrolled students</td></tr>';
                return;
            }
            
            students.forEach(student => {
                const row = document.createElement('tr');
                
                // Determine if the student has a profile image
                const hasImage = student.profileImage ? true : false;
                const imageDisplay = hasImage ? 
                    `<img src="/static/uploads/${student.profileImage}" alt="Student" class="student-thumbnail">` :
                    '<span class="text-muted">No image</span>';
                
                row.innerHTML = `
                    <td>${student.firstName} ${student.lastName}</td>
                    <td>${student.id}</td>
                    <td>${student.yearLevel}</td>
                    <td>${student.phone}</td>
                    <td>${student.email || '-'}</td>
                    <td>${student.className}</td>
                    <td>${imageDisplay}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary upload-image-btn" data-student-id="${student.id}" 
                            data-student-name="${student.firstName} ${student.lastName}">
                            <i class="fas fa-camera"></i> Manage Images
                        </button>
                    </td>
                `;
                studentsTableBody.appendChild(row);
                
                // Add event listener for the upload image button
                const uploadBtn = row.querySelector('.upload-image-btn');
                if (uploadBtn) {
                    uploadBtn.addEventListener('click', () => {
                        showStudentImageModal(student.id, `${student.firstName} ${student.lastName}`);
                    });
                }
            });
        } catch (error) {
            console.error('Error fetching students:', error);
            document.getElementById('instructor-students').innerHTML = 
                '<tr><td colspan="8" class="text-center text-danger">Error loading students. Please try again later.</td></tr>';
        }
    }
    
    async function fetchAttendanceData() {
        try {
            const response = await fetch('/attendance/api/my-classes-today');
            const attendanceData = await response.json();
            
            // Calculate total present students today
            let presentCount = 0;
            let totalCount = 0;
            
            attendanceData.forEach(cls => {
                presentCount += cls.presentCount;
                totalCount += cls.enrolledCount;
            });
            
            document.getElementById('present-count').textContent = presentCount;
            document.getElementById('total-count').textContent = totalCount;
        } catch (error) {
            console.error('Error fetching attendance data:', error);
            document.getElementById('present-count').textContent = '-';
            document.getElementById('total-count').textContent = '-';
        }
    }
    
    function showStudentImageModal(studentId, studentName) {
        // Populate the modal with student information
        document.getElementById('student-id-for-image').value = studentId;
        document.getElementById('student-name-for-image').textContent = studentName;
        document.getElementById('student-id-display').textContent = `ID: ${studentId}`;
        
        // Clear previous file selection
        document.getElementById('student-image-upload').value = '';
        
        // Fetch and display existing images for this student
        fetchStudentImages(studentId);
        
        // Show the modal
        document.getElementById('student-image-modal').classList.add('show');
    }
    
    async function fetchStudentImages(studentId) {
        const imageContainer = document.getElementById('current-images-container');
        imageContainer.innerHTML = '<div class="text-center">Loading images...</div>';
        
        try {
            const response = await fetch(`/students/api/images/${studentId}`);
            const data = await response.json();
            
            if (!data.success) {
                imageContainer.innerHTML = `<div class="text-center text-danger">${data.message}</div>`;
                return;
            }
            
            if (!data.images || data.images.length === 0) {
                imageContainer.innerHTML = '<div class="text-center text-muted">No images available</div>';
                return;
            }
            
            // Display the images
            imageContainer.innerHTML = '';
            data.images.forEach(image => {
                const imageElement = document.createElement('div');
                imageElement.className = 'image-item position-relative';
                imageElement.innerHTML = `
                    <img src="/static/uploads/${image.filename}" alt="Student" class="student-image mb-2">
                    <button type="button" class="btn btn-sm btn-danger delete-image-btn" data-image-id="${image.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                imageContainer.appendChild(imageElement);
                
                // Add event listener for delete button
                const deleteBtn = imageElement.querySelector('.delete-image-btn');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', () => deleteStudentImage(image.id));
                }
            });
        } catch (error) {
            console.error('Error fetching student images:', error);
            imageContainer.innerHTML = '<div class="text-center text-danger">Error loading images. Please try again.</div>';
        }
    }
    
    async function deleteStudentImage(imageId) {
        if (!confirm('Are you sure you want to delete this image?')) {
            return;
        }
        
        try {
            const response = await fetch(`/students/api/delete-image/${imageId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Reload the student images
                const studentId = document.getElementById('student-id-for-image').value;
                fetchStudentImages(studentId);
            } else {
                alert(`Error deleting image: ${result.message}`);
            }
        } catch (error) {
            console.error('Error deleting image:', error);
            alert('Error deleting image. Please try again.');
        }
    }
</script>
<style>
    .student-thumbnail {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 4px;
    }
    
    .student-image {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 4px;
    }
    
    .image-item {
        margin-right: 10px;
        margin-bottom: 10px;
    }
    
    .delete-image-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        padding: 2px 5px;
        border-radius: 50%;
    }
</style>
{% endblock %}