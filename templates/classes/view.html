{% extends "base.html" %}

{% block title %}Class Details{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mt-4">Class Details: <span id="class-name">Loading...</span></h2>
                <a href="javascript:history.back()" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back
                </a>
            </div>
            
            <!-- Class Information Card -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Class Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <dl class="row">
                                <dt class="col-sm-4">Class Code:</dt>
                                <dd class="col-sm-8" id="class-code">Loading...</dd>
                                
                                <dt class="col-sm-4">Description:</dt>
                                <dd class="col-sm-8" id="class-description">Loading...</dd>
                                
                                <dt class="col-sm-4">Schedule:</dt>
                                <dd class="col-sm-8" id="class-schedule">Loading...</dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <dl class="row">
                                <dt class="col-sm-4">Room:</dt>
                                <dd class="col-sm-8" id="class-room">Loading...</dd>
                                
                                <dt class="col-sm-4">Instructor:</dt>
                                <dd class="col-sm-8" id="class-instructor">Loading...</dd>
                                
                                <dt class="col-sm-4">Enrolled Students:</dt>
                                <dd class="col-sm-8" id="class-students">Loading...</dd>
                            </dl>
                        </div>
                    </div>
                    <div class="d-flex justify-content-end mt-3">
                        <button id="take-attendance-btn" class="btn btn-primary">
                            <i class="fas fa-clipboard-check"></i> Take Attendance
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Enrolled Students Card -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center bg-success text-white">
                    <h5 class="card-title mb-0">Enrolled Students</h5>
                    <button id="enroll-student-btn" class="btn btn-light btn-sm">
                        <i class="fas fa-user-plus"></i> Enroll Student
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Year Level</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Profile Image</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="enrolled-students">
                                <tr>
                                    <td colspan="7" class="text-center">Loading enrolled students...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Attendance History Card -->
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5 class="card-title mb-0">Attendance History</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="date-selector" class="form-label">Select Date:</label>
                            <input type="date" id="date-selector" class="form-control">
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button id="view-attendance-btn" class="btn btn-outline-danger">
                                <i class="fas fa-search"></i> View Attendance
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Student ID</th>
                                    <th>Name</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="attendance-records">
                                <tr>
                                    <td colspan="4" class="text-center">Select a date to view attendance</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enroll Student Modal -->
<div class="modal fade" id="enroll-student-modal" tabindex="-1" aria-labelledby="enroll-student-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="enroll-student-modal-label">Enroll Student</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="enroll-student-form" method="post">
                    {{ form.hidden_tag() }}
                    <input type="hidden" id="class-id-field" name="class_id" value="">
                    
                    <div class="mb-3">
                        <label for="student-id-select" class="form-label">Select Student</label>
                        <select class="form-select" id="student-id-select" name="student_id" required>
                            <option value="">-- Select Student --</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Enroll</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Student Image Modal -->
<div class="modal fade" id="student-image-modal" tabindex="-1" aria-labelledby="student-image-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="student-image-modal-label">Student Images</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="student-info mb-3">
                    <h6 id="student-name-display"></h6>
                    <p id="student-id-display" class="text-muted"></p>
                </div>
                
                <div class="current-images mb-4">
                    <h6>Images</h6>
                    <div id="image-gallery" class="d-flex flex-wrap gap-2">
                        <div class="text-center text-muted">No images available</div>
                    </div>
                </div>
                
                <form id="upload-image-form" enctype="multipart/form-data">
                    <input type="hidden" id="student-id-for-image" name="student_id" value="">
                    
                    <div class="mb-3">
                        <label for="image-file" class="form-label">Upload New Image</label>
                        <input type="file" class="form-control" id="image-file" name="image" accept="image/jpeg,image/png" required>
                        <small class="form-text text-muted">Supported formats: JPG, PNG. Max size: 5MB</small>
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Upload</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Global variables
    let classId = null;
    let classData = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Extract class ID from URL
        const pathParts = window.location.pathname.split('/');
        classId = pathParts[pathParts.length - 1];
        
        // Initialize date selector with today's date
        const today = new Date();
        const dateString = today.toISOString().split('T')[0];
        document.getElementById('date-selector').value = dateString;
        
        // Load class data
        loadClassData();
        
        // Set up event listeners
        document.getElementById('take-attendance-btn').addEventListener('click', () => {
            window.location.href = `/attendance/manage?class_id=${classId}`;
        });
        
        document.getElementById('enroll-student-btn').addEventListener('click', showEnrollStudentModal);
        
        document.getElementById('enroll-student-form').addEventListener('submit', enrollStudent);
        
        document.getElementById('view-attendance-btn').addEventListener('click', loadAttendanceForDate);
        
        document.getElementById('upload-image-form').addEventListener('submit', uploadStudentImage);
    });
    
    async function loadClassData() {
        try {
            // Fetch class details
            const response = await fetch(`/classes/api/${classId}`);
            if (!response.ok) {
                throw new Error('Failed to load class details');
            }
            
            classData = await response.json();
            
            // Update class information
            document.getElementById('class-name').textContent = classData.description;
            document.getElementById('class-code').textContent = classData.classCode;
            document.getElementById('class-description').textContent = classData.description;
            document.getElementById('class-schedule').textContent = classData.schedule;
            document.getElementById('class-room').textContent = classData.roomNumber;
            document.getElementById('class-instructor').textContent = classData.instructorName;
            document.getElementById('class-students').textContent = classData.enrolledCount;
            
            // Set class ID for enrollment form
            document.getElementById('class-id-field').value = classId;
            
            // Load enrolled students
            loadEnrolledStudents();
            
            // Load available students for enrollment
            loadAvailableStudents();
            
        } catch (error) {
            console.error('Error loading class data:', error);
            alert('Error loading class data. Please try again later.');
        }
    }
    
    async function loadEnrolledStudents() {
        try {
            const response = await fetch(`/classes/api/${classId}/students`);
            if (!response.ok) {
                throw new Error('Failed to load enrolled students');
            }
            
            const data = await response.json();
            const tableBody = document.getElementById('enrolled-students');
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No students enrolled in this class</td></tr>';
                return;
            }
            
            data.forEach(student => {
                const row = document.createElement('tr');
                
                // Determine if student has a profile image
                const hasImage = student.profileImage ? true : false;
                const imageDisplay = hasImage ? 
                    `<img src="/static/uploads/${student.profileImage}" alt="Student" class="student-thumbnail">` :
                    '<span class="text-muted">No image</span>';
                
                row.innerHTML = `
                    <td>${student.id}</td>
                    <td>${student.firstName} ${student.lastName}</td>
                    <td>${student.yearLevel}</td>
                    <td>${student.phone}</td>
                    <td>${student.email || '-'}</td>
                    <td>${imageDisplay}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-student-images" data-student-id="${student.id}" 
                                data-student-name="${student.firstName} ${student.lastName}">
                            <i class="fas fa-images"></i> Images
                        </button>
                        <button class="btn btn-sm btn-outline-danger unenroll-student" data-student-id="${student.id}">
                            <i class="fas fa-user-minus"></i> Unenroll
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Add event listeners to view images buttons
            document.querySelectorAll('.view-student-images').forEach(button => {
                button.addEventListener('click', () => {
                    const studentId = button.getAttribute('data-student-id');
                    const studentName = button.getAttribute('data-student-name');
                    showStudentImagesModal(studentId, studentName);
                });
            });
            
            // Add event listeners to unenroll buttons
            document.querySelectorAll('.unenroll-student').forEach(button => {
                button.addEventListener('click', () => {
                    const studentId = button.getAttribute('data-student-id');
                    unenrollStudent(studentId);
                });
            });
            
        } catch (error) {
            console.error('Error loading enrolled students:', error);
            document.getElementById('enrolled-students').innerHTML = 
                '<tr><td colspan="7" class="text-center text-danger">Error loading students. Please try again later.</td></tr>';
        }
    }
    
    async function loadAvailableStudents() {
        try {
            // Fetch all students and filter out those already enrolled
            const response = await fetch('/students/api/list');
            const allStudents = await response.json();
            
            // Get enrolled student IDs
            const enrolledResponse = await fetch(`/classes/api/${classId}/students`);
            const enrolledStudents = await enrolledResponse.json();
            const enrolledIds = enrolledStudents.map(student => student.id);
            
            // Filter to students not already enrolled
            const availableStudents = allStudents.filter(student => !enrolledIds.includes(student.id));
            
            // Update the dropdown
            const selectElement = document.getElementById('student-id-select');
            selectElement.innerHTML = '<option value="">-- Select Student --</option>';
            
            availableStudents.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.firstName} ${student.lastName} (${student.id})`;
                selectElement.appendChild(option);
            });
            
        } catch (error) {
            console.error('Error loading available students:', error);
        }
    }
    
    function showEnrollStudentModal() {
        const modal = new bootstrap.Modal(document.getElementById('enroll-student-modal'));
        modal.show();
    }
    
    async function enrollStudent(event) {
        event.preventDefault();
        
        const studentId = document.getElementById('student-id-select').value;
        
        if (!studentId) {
            alert('Please select a student to enroll');
            return;
        }
        
        try {
            const response = await fetch(`/classes/api/${classId}/enroll`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    student_id: studentId
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Close the modal
                bootstrap.Modal.getInstance(document.getElementById('enroll-student-modal')).hide();
                
                // Reload the enrolled students list
                loadEnrolledStudents();
                
                // Reload available students for enrollment
                loadAvailableStudents();
                
                // Update class information
                loadClassData();
                
                alert('Student enrolled successfully!');
            } else {
                alert(`Error enrolling student: ${result.message}`);
            }
            
        } catch (error) {
            console.error('Error enrolling student:', error);
            alert('Error enrolling student. Please try again later.');
        }
    }
    
    async function unenrollStudent(studentId) {
        if (!confirm('Are you sure you want to unenroll this student from the class?')) {
            return;
        }
        
        try {
            const response = await fetch(`/classes/api/${classId}/unenroll/${studentId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Reload the enrolled students list
                loadEnrolledStudents();
                
                // Reload available students for enrollment
                loadAvailableStudents();
                
                // Update class information
                loadClassData();
                
                alert('Student unenrolled successfully!');
            } else {
                alert(`Error unenrolling student: ${result.message}`);
            }
            
        } catch (error) {
            console.error('Error unenrolling student:', error);
            alert('Error unenrolling student. Please try again later.');
        }
    }
    
    async function loadAttendanceForDate() {
        const date = document.getElementById('date-selector').value;
        
        if (!date) {
            alert('Please select a date');
            return;
        }
        
        try {
            const response = await fetch(`/attendance/api/class/${classId}/attendance?date=${date}`);
            const data = await response.json();
            
            const tableBody = document.getElementById('attendance-records');
            tableBody.innerHTML = '';
            
            if (data.attendance.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center">No attendance records found for this date</td></tr>';
                return;
            }
            
            data.attendance.forEach(record => {
                const row = document.createElement('tr');
                
                // Determine status color
                let statusClass = '';
                if (record.status === 'Present') {
                    statusClass = 'bg-success text-white';
                } else if (record.status === 'Absent') {
                    statusClass = 'bg-danger text-white';
                } else if (record.status === 'Late') {
                    statusClass = 'bg-warning';
                }
                
                row.innerHTML = `
                    <td>${record.studentId}</td>
                    <td>${record.studentName}</td>
                    <td class="${statusClass}">${record.status}</td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-success mark-present" data-student-id="${record.studentId}" data-date="${date}">
                                Present
                            </button>
                            <button class="btn btn-sm btn-outline-danger mark-absent" data-student-id="${record.studentId}" data-date="${date}">
                                Absent
                            </button>
                            <button class="btn btn-sm btn-outline-warning mark-late" data-student-id="${record.studentId}" data-date="${date}">
                                Late
                            </button>
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Add event listeners to attendance buttons
            document.querySelectorAll('.mark-present').forEach(button => {
                button.addEventListener('click', () => {
                    updateAttendance(button.getAttribute('data-student-id'), date, 'Present');
                });
            });
            
            document.querySelectorAll('.mark-absent').forEach(button => {
                button.addEventListener('click', () => {
                    updateAttendance(button.getAttribute('data-student-id'), date, 'Absent');
                });
            });
            
            document.querySelectorAll('.mark-late').forEach(button => {
                button.addEventListener('click', () => {
                    updateAttendance(button.getAttribute('data-student-id'), date, 'Late');
                });
            });
            
        } catch (error) {
            console.error('Error loading attendance records:', error);
            document.getElementById('attendance-records').innerHTML = 
                '<tr><td colspan="4" class="text-center text-danger">Error loading attendance records. Please try again later.</td></tr>';
        }
    }
    
    async function updateAttendance(studentId, date, status) {
        try {
            const response = await fetch('/attendance/api/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    classId: classId,
                    studentId: studentId,
                    date: date,
                    status: status
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Reload attendance for the date
                loadAttendanceForDate();
            } else {
                alert(`Error updating attendance: ${result.message}`);
            }
            
        } catch (error) {
            console.error('Error updating attendance:', error);
            alert('Error updating attendance. Please try again later.');
        }
    }
    
    function showStudentImagesModal(studentId, studentName) {
        // Set student info in the modal
        document.getElementById('student-name-display').textContent = studentName;
        document.getElementById('student-id-display').textContent = `ID: ${studentId}`;
        document.getElementById('student-id-for-image').value = studentId;
        
        // Clear previous image upload
        document.getElementById('image-file').value = '';
        
        // Load existing images
        loadStudentImages(studentId);
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('student-image-modal'));
        modal.show();
    }
    
    async function loadStudentImages(studentId) {
        const galleryElement = document.getElementById('image-gallery');
        galleryElement.innerHTML = '<div class="text-center">Loading images...</div>';
        
        try {
            const response = await fetch(`/students/api/images/${studentId}`);
            const data = await response.json();
            
            if (!data.success) {
                galleryElement.innerHTML = `<div class="text-center text-danger">${data.message}</div>`;
                return;
            }
            
            if (!data.images || data.images.length === 0) {
                galleryElement.innerHTML = '<div class="text-center text-muted">No images available</div>';
                return;
            }
            
            // Display the images
            galleryElement.innerHTML = '';
            data.images.forEach(image => {
                const imageElement = document.createElement('div');
                imageElement.className = 'image-item position-relative';
                imageElement.innerHTML = `
                    <img src="${image.path}" alt="Student" class="student-image mb-2">
                    <button type="button" class="btn btn-sm btn-danger delete-image-btn" data-image-id="${image.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                galleryElement.appendChild(imageElement);
                
                // Add event listener for delete button
                const deleteBtn = imageElement.querySelector('.delete-image-btn');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', () => deleteStudentImage(image.id));
                }
            });
            
        } catch (error) {
            console.error('Error loading student images:', error);
            galleryElement.innerHTML = '<div class="text-center text-danger">Error loading images. Please try again.</div>';
        }
    }
    
    async function uploadStudentImage(event) {
        event.preventDefault();
        
        const studentId = document.getElementById('student-id-for-image').value;
        const imageFile = document.getElementById('image-file').files[0];
        
        if (!studentId || !imageFile) {
            alert('Please select an image to upload');
            return;
        }
        
        const formData = new FormData();
        formData.append('student_id', studentId);
        formData.append('image', imageFile);
        
        try {
            const response = await fetch('/students/api/upload-image', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Reload student images
                loadStudentImages(studentId);
                
                // Clear the file input
                document.getElementById('image-file').value = '';
                
                alert('Image uploaded successfully!');
                
                // Reload enrolled students to update profile images
                loadEnrolledStudents();
            } else {
                alert(`Error uploading image: ${result.message}`);
            }
            
        } catch (error) {
            console.error('Error uploading image:', error);
            alert('Error uploading image. Please try again later.');
        }
    }
    
    async function deleteStudentImage(imageId) {
        if (!confirm('Are you sure you want to delete this image?')) {
            return;
        }
        
        try {
            const response = await fetch(`/students/api/delete-image/${imageId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Reload student images
                const studentId = document.getElementById('student-id-for-image').value;
                loadStudentImages(studentId);
                
                // Reload enrolled students to update profile images
                loadEnrolledStudents();
                
                alert('Image deleted successfully!');
            } else {
                alert(`Error deleting image: ${result.message}`);
            }
            
        } catch (error) {
            console.error('Error deleting image:', error);
            alert('Error deleting image. Please try again later.');
        }
    }
</script>
<style>
    .student-thumbnail {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 4px;
    }
    
    .student-image {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border-radius: 4px;
    }
    
    .image-item {
        margin-right: 10px;
        margin-bottom: 10px;
    }
    
    .delete-image-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        padding: 2px 5px;
        border-radius: 50%;
    }
</style>
{% endblock %}